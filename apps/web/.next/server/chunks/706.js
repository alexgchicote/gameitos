exports.id=706,exports.ids=[706],exports.modules={658:()=>{},6818:(e,t,a)=>{"use strict";a.d(t,{jq:()=>$,JV:()=>R,dt:()=>v,Cf:()=>M,o$:()=>K,db:()=>L,jx:()=>N,AL:()=>D,DF:()=>T,Ee:()=>z,hI:()=>x,RM:()=>Q});var i={};a.r(i),a.d(i,{gameResults:()=>w,gameResultsRelations:()=>A,gameTypes:()=>c,gameTypesRelations:()=>I,games:()=>y,gamesRelations:()=>g,matches:()=>f,matchesRelations:()=>P,players:()=>p,playersRelations:()=>h});var n=a(6439),r=a(1628),s=a(6955),d=a(106),o=a(8976),l=a(8452),m=a(7981),u=a(6515);let p=(0,d.cJ)("players",{id:(0,o.uR)("id").primaryKey().defaultRandom(),name:(0,l.Qq)("name").notNull(),totalPoints:(0,m.nd)("total_points").default(0),gamesPlayed:(0,m.nd)("games_played").default(0),wins:(0,m.nd)("wins").default(0),podiums:(0,m.nd)("podiums").default(0),createdAt:(0,u.vE)("created_at",{withTimezone:!0}).defaultNow(),updatedAt:(0,u.vE)("updated_at",{withTimezone:!0}).defaultNow()}),c=(0,d.cJ)("game_types",{id:(0,o.uR)("id").primaryKey().defaultRandom(),name:(0,l.Qq)("name").notNull(),description:(0,l.Qq)("description"),createdAt:(0,u.vE)("created_at",{withTimezone:!0}).defaultNow(),updatedAt:(0,u.vE)("updated_at",{withTimezone:!0}).defaultNow()}),y=(0,d.cJ)("games",{id:(0,o.uR)("id").primaryKey().defaultRandom(),name:(0,l.Qq)("name").notNull().unique(),gameTypeId:(0,o.uR)("game_type_id").references(()=>c.id).notNull(),description:(0,l.Qq)("description"),minPlayers:(0,m.nd)("min_players").default(2),maxPlayers:(0,m.nd)("max_players"),isActive:(0,l.Qq)("is_active").default("true"),createdAt:(0,u.vE)("created_at",{withTimezone:!0}).defaultNow(),updatedAt:(0,u.vE)("updated_at",{withTimezone:!0}).defaultNow()}),f=(0,d.cJ)("game_matches",{id:(0,o.uR)("id").primaryKey().defaultRandom(),gameId:(0,o.uR)("game_id").references(()=>y.id).notNull(),matchName:(0,l.Qq)("match_name"),totalPlayers:(0,m.nd)("total_players").notNull(),status:(0,l.Qq)("status").default("completed"),startedAt:(0,u.vE)("started_at",{withTimezone:!0}).defaultNow(),completedAt:(0,u.vE)("completed_at",{withTimezone:!0}),createdAt:(0,u.vE)("created_at",{withTimezone:!0}).defaultNow()}),w=(0,d.cJ)("game_results",{id:(0,o.uR)("id").primaryKey().defaultRandom(),gameMatchId:(0,o.uR)("game_match_id").references(()=>f.id).notNull(),playerId:(0,o.uR)("player_id").references(()=>p.id).notNull(),position:(0,m.nd)("position").notNull(),pointsAwarded:(0,m.nd)("points_awarded").notNull(),positionFromMedian:(0,m.nd)("position_from_median").notNull(),createdAt:(0,u.vE)("created_at",{withTimezone:!0}).defaultNow()}),h=(0,s.K1)(p,({many:e})=>({gameResults:e(w)})),g=(0,s.K1)(y,({one:e,many:t})=>({gameType:e(c,{fields:[y.gameTypeId],references:[c.id]}),matches:t(f)})),A=(0,s.K1)(w,({one:e})=>({gameMatch:e(f,{fields:[w.gameMatchId],references:[f.id]}),player:e(p,{fields:[w.playerId],references:[p.id]})})),I=(0,s.K1)(c,({many:e})=>({games:e(y)})),P=(0,s.K1)(f,({one:e,many:t})=>({game:e(y,{fields:[f.gameId],references:[y.id]}),results:t(w)}));async function N(){return await L.select({id:c.id,name:c.name,description:c.description,createdAt:c.createdAt}).from(c).orderBy(c.name)}async function v(e){let[t]=await L.insert(c).values({name:e.name,description:e.description}).returning();return t}var _=a(5156);async function R(e){let[t]=await L.insert(y).values({name:e.name,gameTypeId:e.gameTypeId,description:e.description,minPlayers:e.minPlayers||2,maxPlayers:e.maxPlayers,isActive:!1!==e.isActive?"true":"false"}).returning();return t}async function T(){return await L.select({id:y.id,name:y.name,gameTypeId:y.gameTypeId,minPlayers:y.minPlayers,maxPlayers:y.maxPlayers}).from(y).where((0,_.eq)(y.isActive,"true")).orderBy(y.name)}var q=a(6160),E=a(4514);async function M(e){let[t]=await L.insert(f).values({gameId:e.gameId,matchName:e.matchName,totalPlayers:e.playerIds.length,status:"in_progress"}).returning();return t}async function $(e){let[t]=await L.select().from(f).where((0,_.eq)(f.id,e.matchId));if(!t)throw Error("Match not found");if(e.results.length!==t.totalPlayers)throw Error(`Expected ${t.totalPlayers} results, got ${e.results.length}`);let a=e.results.map(e=>e.position);if(new Set(a).size!==a.length)throw Error("Duplicate positions detected");let i=[...a].sort((e,t)=>e-t);for(let e=0;e<i.length;e++)if(i[e]!==e+1)throw Error(`Invalid position sequence. Expected ${e+1}, got ${i[e]}`);let n=e.results.map(a=>{var i,n;return{gameMatchId:e.matchId,playerId:a.playerId,position:a.position,pointsAwarded:(i=a.position,n=t.totalPlayers,i<1||i>n||n<1?0:function(e){if(e<=0)return[];if(1===e)return[0];let t=e=>{if(e<=0)return[];if(1===e)return[1];let t=[1,2];for(let a=2;a<e;a++)t.push(t[a-1]+t[a-2]);return t},a=[];if(e%2==1){let i=Math.floor(e/2);if(0===i)a.push(0);else{let e=t(i),n=[...e].reverse(),r=[...e].map(e=>-e);a.push(...n),a.push(0),a.push(...r)}}else{let i=e/2;if(1===i)a.push(1,-1);else{let e=t(i),n=[...e].reverse(),r=[...e].map(e=>-e);a.push(...n),a.push(...r)}}return a}(n)[i-1]||0),positionFromMedian:function(e,t){if(e<1||e>t||t<1)return 0;if(t%2==1)return(t+1)/2-e;let a=t/2,i=a+1;return e<=a?a-e:e>=i?-(e-i):0}(a.position,t.totalPlayers)}});return await L.transaction(async t=>{for(let a of(await t.insert(w).values(n),await t.update(f).set({status:"completed",completedAt:new Date}).where((0,_.eq)(f.id,e.matchId)),n))await t.update(p).set({totalPoints:(0,q.ll)`${p.totalPoints} + ${a.pointsAwarded}`,gamesPlayed:(0,q.ll)`${p.gamesPlayed} + 1`,wins:1===a.position?(0,q.ll)`${p.wins} + 1`:p.wins,podiums:a.position<=3?(0,q.ll)`${p.podiums} + 1`:p.podiums,updatedAt:new Date}).where((0,_.eq)(p.id,a.playerId))}),await J(e.matchId)}async function J(e){let t=await L.select({id:f.id,matchName:f.matchName,totalPlayers:f.totalPlayers,status:f.status,startedAt:f.startedAt,completedAt:f.completedAt,createdAt:f.createdAt,gameId:y.id,gameName:y.name,gameTypeId:c.id,gameTypeName:c.name}).from(f).innerJoin(y,(0,_.eq)(f.gameId,y.id)).innerJoin(c,(0,_.eq)(y.gameTypeId,c.id)).where((0,_.eq)(f.id,e));if(!t.length)throw Error("Match not found");let a=await L.select({id:w.id,position:w.position,pointsAwarded:w.pointsAwarded,positionFromMedian:w.positionFromMedian,player:{id:p.id,name:p.name}}).from(w).innerJoin(p,(0,_.eq)(w.playerId,p.id)).where((0,_.eq)(w.gameMatchId,e)).orderBy(w.position);return{...t[0],results:a}}async function x(e=10){let t=await L.select({id:f.id,matchName:f.matchName,totalPlayers:f.totalPlayers,status:f.status,startedAt:f.startedAt,completedAt:f.completedAt,createdAt:f.createdAt,gameId:y.id,gameName:y.name,gameTypeId:c.id,gameTypeName:c.name}).from(f).innerJoin(y,(0,_.eq)(f.gameId,y.id)).innerJoin(c,(0,_.eq)(y.gameTypeId,c.id)).where((0,_.eq)(f.status,"completed")).orderBy((0,E.i)(f.completedAt)).limit(e);return await Promise.all(t.map(async e=>{let t=await L.select({position:w.position,player:{id:p.id,name:p.name}}).from(w).innerJoin(p,(0,_.eq)(w.playerId,p.id)).where((0,_.eq)(w.gameMatchId,e.id)).orderBy(w.position),a=t.find(e=>1===e.position),i=t.find(t=>t.position===e.totalPlayers);return{...e,winner:a?a.player:null,lastPlace:i?i.player:null}}))}async function z(e=50,t={}){let a=await L.select({id:p.id,name:p.name,totalPoints:p.totalPoints,gamesPlayed:p.gamesPlayed,wins:p.wins,podiums:p.podiums}).from(p).where(t.minGames?(0,q.ll)`${p.gamesPlayed} >= ${t.minGames}`:void 0).orderBy((0,E.i)(p.totalPoints)).limit(e);return await Promise.all(a.map(async e=>{let t=await B(e.id,5),a=e.totalPoints??0,i=e.gamesPlayed??0,n=e.wins??0,r=e.podiums??0;return{id:e.id,name:e.name,totalPoints:a,gamesPlayed:i,wins:n,podiums:r,winRate:i>0?n/i*100:0,podiumRate:i>0?r/i*100:0,averagePoints:i>0?a/i:0,recentForm:t}}))}async function B(e,t=5){return(await L.select({position:w.positionFromMedian}).from(w).innerJoin(f,(0,_.eq)(w.gameMatchId,f.id)).where((0,_.eq)(w.playerId,e)).orderBy(f.completedAt).limit(t)).map(e=>e.position)}async function K(e){let t=process.env.DATABASE_URL;if(!t)throw Error("DATABASE_URL environment variable is not set");let a=(0,r.A)(t);try{let t=await a`
      INSERT INTO players (name) 
      VALUES (${e.name}) 
      RETURNING *
    `;return await a.end(),t[0]}catch(e){throw await a.end(),console.error("Database error:",e),e}}async function D(){return await L.select().from(p)}async function Q(e){return await L.select().from(p).where((0,_.mj)(p.name,`%${e}%`))}let F=process.env.DATABASE_URL,S=(0,r.A)(F),L=(0,n.f)(S,{schema:i})},9821:()=>{}};