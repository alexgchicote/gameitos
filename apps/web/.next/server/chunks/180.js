exports.id=180,exports.ids=[180],exports.modules={658:()=>{},1804:(e,t,a)=>{"use strict";a.d(t,{Xd:()=>J,JV:()=>q,MR:()=>M,dt:()=>_,o$:()=>Q,db:()=>L,jx:()=>N,AL:()=>D,DF:()=>E,Ee:()=>B,Po:()=>x,jQ:()=>z,RM:()=>S});var i={};a.r(i),a.d(i,{gameMatches:()=>f,gameMatchesRelations:()=>P,gameResults:()=>w,gameResultsRelations:()=>A,gameTypes:()=>c,gameTypesRelations:()=>I,games:()=>y,gamesRelations:()=>h,players:()=>u,playersRelations:()=>g});var n=a(6439),r=a(1628),s=a(6955),d=a(106),o=a(8976),l=a(8452),m=a(7981),p=a(6515);let u=(0,d.cJ)("players",{id:(0,o.uR)("id").primaryKey().defaultRandom(),name:(0,l.Qq)("name").notNull(),totalPoints:(0,m.nd)("total_points").default(0),gamesPlayed:(0,m.nd)("games_played").default(0),wins:(0,m.nd)("wins").default(0),podiums:(0,m.nd)("podiums").default(0),createdAt:(0,p.vE)("created_at",{withTimezone:!0}).defaultNow(),updatedAt:(0,p.vE)("updated_at",{withTimezone:!0}).defaultNow()}),c=(0,d.cJ)("game_types",{id:(0,o.uR)("id").primaryKey().defaultRandom(),name:(0,l.Qq)("name").notNull(),description:(0,l.Qq)("description"),createdAt:(0,p.vE)("created_at",{withTimezone:!0}).defaultNow(),updatedAt:(0,p.vE)("updated_at",{withTimezone:!0}).defaultNow()}),y=(0,d.cJ)("games",{id:(0,o.uR)("id").primaryKey().defaultRandom(),name:(0,l.Qq)("name").notNull().unique(),gameTypeId:(0,o.uR)("game_type_id").references(()=>c.id).notNull(),description:(0,l.Qq)("description"),minPlayers:(0,m.nd)("min_players").default(2),maxPlayers:(0,m.nd)("max_players"),isActive:(0,l.Qq)("is_active").default("true"),createdAt:(0,p.vE)("created_at",{withTimezone:!0}).defaultNow(),updatedAt:(0,p.vE)("updated_at",{withTimezone:!0}).defaultNow()}),f=(0,d.cJ)("game_matches",{id:(0,o.uR)("id").primaryKey().defaultRandom(),gameId:(0,o.uR)("game_id").references(()=>y.id).notNull(),matchName:(0,l.Qq)("match_name"),totalPlayers:(0,m.nd)("total_players").notNull(),status:(0,l.Qq)("status").default("completed"),startedAt:(0,p.vE)("started_at",{withTimezone:!0}).defaultNow(),completedAt:(0,p.vE)("completed_at",{withTimezone:!0}),createdAt:(0,p.vE)("created_at",{withTimezone:!0}).defaultNow()}),w=(0,d.cJ)("game_results",{id:(0,o.uR)("id").primaryKey().defaultRandom(),gameMatchId:(0,o.uR)("game_match_id").references(()=>f.id).notNull(),playerId:(0,o.uR)("player_id").references(()=>u.id).notNull(),position:(0,m.nd)("position").notNull(),pointsAwarded:(0,m.nd)("points_awarded").notNull(),positionFromMedian:(0,m.nd)("position_from_median"),createdAt:(0,p.vE)("created_at",{withTimezone:!0}).defaultNow()}),g=(0,s.K1)(u,({many:e})=>({gameResults:e(w)})),h=(0,s.K1)(y,({one:e,many:t})=>({gameType:e(c,{fields:[y.gameTypeId],references:[c.id]}),matches:t(f)})),A=(0,s.K1)(w,({one:e})=>({gameMatch:e(f,{fields:[w.gameMatchId],references:[f.id]}),player:e(u,{fields:[w.playerId],references:[u.id]})})),I=(0,s.K1)(c,({many:e})=>({games:e(y)})),P=(0,s.K1)(f,({one:e,many:t})=>({game:e(y,{fields:[f.gameId],references:[y.id]}),results:t(w)}));async function N(){return await L.select({id:c.id,name:c.name,description:c.description,createdAt:c.createdAt}).from(c).orderBy(c.name)}async function _(e){let[t]=await L.insert(c).values({name:e.name,description:e.description}).returning();return t}var v=a(5156),R=a(6160),T=a(4514);async function q(e){let[t]=await L.insert(y).values({name:e.name,gameTypeId:e.gameTypeId,description:e.description,minPlayers:e.minPlayers||2,maxPlayers:e.maxPlayers,isActive:!1!==e.isActive?"true":"false"}).returning();return t}async function E(){return await L.select({id:y.id,name:y.name,gameTypeId:c.id,gameTypeName:c.name,minPlayers:y.minPlayers,maxPlayers:y.maxPlayers}).from(y).innerJoin(c,(0,v.eq)(y.gameTypeId,c.id)).where((0,v.eq)(y.isActive,"true")).orderBy(y.name)}async function M(e){let[t]=await L.insert(f).values({gameId:e.gameId,matchName:e.matchName,totalPlayers:e.playerIds.length,status:"in_progress"}).returning();return t}async function J(e){let[t]=await L.select().from(f).where((0,v.eq)(f.id,e.gameMatchId));if(!t)throw Error("Game match not found");if(e.results.length!==t.totalPlayers)throw Error(`Expected ${t.totalPlayers} results, got ${e.results.length}`);let a=e.results.map(e=>e.position);if(new Set(a).size!==a.length)throw Error("Duplicate positions detected");let i=[...a].sort((e,t)=>e-t);for(let e=0;e<i.length;e++)if(i[e]!==e+1)throw Error(`Invalid position sequence. Expected ${e+1}, got ${i[e]}`);let n=e.results.map(a=>{var i,n,r,s;return{gameMatchId:e.gameMatchId,playerId:a.playerId,position:a.position,pointsAwarded:(i=a.position,n=t.totalPlayers,i<1||i>n||n<1?0:function(e){if(e<=0)return[];if(1===e)return[0];let t=e=>{if(e<=0)return[];if(1===e)return[1];let t=[1,2];for(let a=2;a<e;a++)t.push(t[a-1]+t[a-2]);return t},a=[];if(e%2==1){let i=Math.floor(e/2);if(0===i)a.push(0);else{let e=t(i),n=[...e].reverse(),r=[...e].map(e=>-e);a.push(...n),a.push(0),a.push(...r)}}else{let i=e/2;if(1===i)a.push(1,-1);else{let e=t(i),n=[...e].reverse(),r=[...e].map(e=>-e);a.push(...n),a.push(...r)}}return a}(n)[i-1]||0),positionFromMedian:(r=a.position,s=t.totalPlayers,r<1||r>s||s<1?0:Math.round((s+1)/2-r))}});return await L.transaction(async t=>{for(let a of(await t.insert(w).values(n),await t.update(f).set({status:"completed",completedAt:new Date}).where((0,v.eq)(f.id,e.gameMatchId)),n))await t.update(u).set({totalPoints:(0,R.ll)`${u.totalPoints} + ${a.pointsAwarded}`,gamesPlayed:(0,R.ll)`${u.gamesPlayed} + 1`,wins:1===a.position?(0,R.ll)`${u.wins} + 1`:u.wins,podiums:a.position<=3?(0,R.ll)`${u.podiums} + 1`:u.podiums,updatedAt:new Date}).where((0,v.eq)(u.id,a.playerId))}),await $(e.gameMatchId)}async function $(e){let t=await L.select({id:f.id,matchName:f.matchName,totalPlayers:f.totalPlayers,status:f.status,startedAt:f.startedAt,completedAt:f.completedAt,createdAt:f.createdAt,gameId:y.id,gameName:y.name,gameTypeId:c.id,gameTypeName:c.name}).from(f).innerJoin(y,(0,v.eq)(f.gameId,y.id)).innerJoin(c,(0,v.eq)(y.gameTypeId,c.id)).where((0,v.eq)(f.id,e));if(!t.length)throw Error("Game match not found");let a=await L.select({id:w.id,position:w.position,pointsAwarded:w.pointsAwarded,positionFromMedian:w.positionFromMedian,player:{id:u.id,name:u.name}}).from(w).innerJoin(u,(0,v.eq)(w.playerId,u.id)).where((0,v.eq)(w.gameMatchId,e)).orderBy(w.position);return{...t[0],results:a}}async function x(e=10){let t=await L.select({id:f.id,matchName:f.matchName,totalPlayers:f.totalPlayers,status:f.status,startedAt:f.startedAt,completedAt:f.completedAt,createdAt:f.createdAt,gameId:y.id,gameName:y.name,gameTypeId:c.id,gameTypeName:c.name}).from(f).innerJoin(y,(0,v.eq)(f.gameId,y.id)).innerJoin(c,(0,v.eq)(y.gameTypeId,c.id)).where((0,v.eq)(f.status,"completed")).orderBy((0,T.i)(f.completedAt)).limit(e);return await Promise.all(t.map(async e=>{let t=await L.select({position:w.position,player:{id:u.id,name:u.name}}).from(w).innerJoin(u,(0,v.eq)(w.playerId,u.id)).where((0,v.eq)(w.gameMatchId,e.id)).orderBy(w.position),a=t.find(e=>1===e.position),i=t.find(t=>t.position===e.totalPlayers);return{...e,winner:a?a.player:null,lastPlace:i?i.player:null}}))}let z=x;async function B(e=50,t={}){let a=await L.select({id:u.id,name:u.name,totalPoints:u.totalPoints,gamesPlayed:u.gamesPlayed,wins:u.wins,podiums:u.podiums}).from(u).where(t.minGames?(0,R.ll)`${u.gamesPlayed} >= ${t.minGames}`:void 0).orderBy((0,T.i)(u.totalPoints)).limit(e);return await Promise.all(a.map(async e=>{let t=await K(e.id,5),a=e.totalPoints??0,i=e.gamesPlayed??0,n=e.wins??0,r=e.podiums??0;return{id:e.id,name:e.name,totalPoints:a,gamesPlayed:i,wins:n,podiums:r,winRate:i>0?n/i*100:0,podiumRate:i>0?r/i*100:0,averagePoints:i>0?a/i:0,recentForm:t}}))}async function K(e,t=5){return(await L.select({position:w.position}).from(w).innerJoin(f,(0,v.eq)(w.gameMatchId,f.id)).where((0,v.eq)(w.playerId,e)).orderBy((0,T.i)(f.completedAt)).limit(t)).map(e=>e.position)}async function Q(e){let t=process.env.DATABASE_URL;if(!t)throw Error("DATABASE_URL environment variable is not set");let a=(0,r.A)(t);try{let t=await a`
      INSERT INTO players (name) 
      VALUES (${e.name}) 
      RETURNING *
    `;return await a.end(),t[0]}catch(e){throw await a.end(),console.error("Database error:",e),e}}async function D(){return await L.select().from(u)}async function S(e){return await L.select().from(u).where((0,v.mj)(u.name,`%${e}%`))}let F=process.env.DATABASE_URL,G=(0,r.A)(F),L=(0,n.f)(G,{schema:i})},2202:()=>{}};